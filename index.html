<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Generador de Flores</title>
<style>
  :root{ --bg:#0b0f1a; --panel:#0f172a; --line:#1f2a3a; --txt:#eaf2ff; }
  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--txt); font-family:system-ui,Inter,Arial }

  .layout{ min-height:100%; display:flex; flex-direction:column }
  @media (min-width:960px){ .layout{ flex-direction:row } }

  /* VISOR */
  .viewer{ flex:1; display:flex; align-items:center; justify-content:center; padding:1rem; }
  .stage{
    position:relative; display:grid; place-items:center;
    width:min(92vw, 720px); aspect-ratio:1/1;
    border:8px solid #151f33; border-radius:18px; overflow:hidden;
    box-shadow:0 10px 40px rgba(0,0,0,.45);
    background: radial-gradient(120% 120% at 50% 15%, #0f1730 0%, #0b0f1a 65%);
  }
  canvas{ width:100%; height:100%; display:block; background:transparent; }

  /* CONTROLES (acordeón / tabs) */
  .controls{
    background:var(--panel); border-top:1px solid var(--line);
    padding:1rem; display:grid; gap:.9rem;
  }
  @media (min-width:960px){
    .controls{ width:360px; border-top:none; border-left:1px solid var(--line); overflow:auto; }
  }

  /* ---- Barra de pestañas (móvil) ---- */
  .tabbar{ display:none; }
  @media (max-width:959px){
    .tabbar{
      display:flex; gap:.5rem; padding:.25rem; background:rgba(255,255,255,.03);
      border:1px solid #1a2540; border-radius:.8rem; position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(120%) blur(6px);
    }
    .tab{
      flex:1; text-align:center; padding:.6rem .7rem; border-radius:.6rem; cursor:pointer;
      background:#0c1427; border:1px solid #1a2540; color:var(--txt); font-weight:500; white-space:nowrap;
    }
    .tab[aria-selected="true"]{
      background:#13203a; border-color:#2a3a63; box-shadow: inset 0 0 0 1px #2a3a63;
    }
  }

  .acc-item{ border:1px solid #1a2540; border-radius:.8rem; background:#0c1427; overflow:hidden; }
  .acc-btn{
    width:100%; text-align:left; padding:.85rem 1rem; background:transparent; color:var(--txt);
    border:none; display:flex; align-items:center; justify-content:space-between; cursor:pointer; font-size:1rem;
  }
  .acc-btn .chev{ transition: transform .22s ease; opacity:.8; }
  .acc-btn[aria-expanded="true"] .chev{ transform: rotate(90deg); }
  .acc-btn:hover{ background:#0f1724; }

  .acc-panel{
    grid-template-columns:140px 1fr;
    display:grid; gap:.6rem; align-items:center;
    padding:0 1rem; border-top:1px solid #1a2540;
    transition: max-height .25s ease, padding .25s ease;
    max-height:0; padding-top:0; padding-bottom:0; overflow:hidden;
  }
  .acc-item.open .acc-panel{ max-height:900px; padding-top:.8rem; padding-bottom:.9rem; }

  /* En móvil: tabs → ocultar botones de acordeón, mostrar solo el panel activo */
  @media (max-width:959px){
    .acc-btn{ display:none; }
    .acc-panel{ max-height:none; padding:.9rem 1rem; display:none; }
    .acc-item.open .acc-panel{ display:grid; }
  }

  .row{ display:contents; }
  .row label{ align-self:center; }

  /* filas apiladas (label encima del control) */
  .row.stack{ display:grid; grid-template-columns:1fr; grid-column:1 / -1; }
  .row.stack label{ margin-bottom:.35rem; }

  input[type="range"], input[type="color"], input[type="number"], select{
    width:100%; background:#0f1724; color:var(--txt);
    border:1px solid #233253; border-radius:.5rem; padding:.38rem; touch-action:manipulation;
  }
  .inline{ display:flex; gap:.5rem; align-items:center }
  .btn{ background:#15213a; border:1px solid #2a3a63; color:var(--txt); padding:.45rem .7rem; border-radius:.55rem; cursor:pointer; }
  .btn:active{ transform:translateY(1px) }
  .hint{ font-size:.8rem; opacity:.75; grid-column:1 / -1; }
</style>
</head>
<body>
<div class="layout">
  <div class="viewer">
    <div class="stage">
      <canvas id="flower" width="900" height="900"></canvas>
    </div>
  </div>

  <div class="controls" id="accordion">
    <!-- TABBAR (solo móvil) -->
    <div class="tabbar" id="tabbar" role="tablist" aria-label="Controles">
      <button class="tab" role="tab" aria-selected="true" data-target="sec-flor">Flor</button>
      <button class="tab" role="tab" aria-selected="false" data-target="sec-color">Color</button>
      <button class="tab" role="tab" aria-selected="false" data-target="sec-centro">Centro</button>
      <button class="tab" role="tab" aria-selected="false" data-target="sec-modos">Modos</button>
    </div>

    <!-- FLOR -->
    <section class="acc-item open" id="sec-flor">
      <button class="acc-btn" aria-expanded="true"><span>Flor</span><span class="chev">▶</span></button>
      <div class="acc-panel">
        <div class="row"><label for="petals">Nº pétalos</label><input id="petals" type="range" min="3" max="64" value="12"></div>
        <div class="row"><label for="pLen">Largo pétalo</label><input id="pLen" type="range" min="0.3" max="1.0" step="0.01" value="0.8"></div>
        <div class="row"><label for="pWid">Ancho pétalo</label><input id="pWid" type="range" min="0.10" max="0.70" step="0.01" value="0.35"></div>
        <div class="row"><label for="pCurve">Curvatura</label><input id="pCurve" type="range" min="0" max="1" step="0.01" value="0.6"></div>
        <div class="row"><label for="rot0">Rotación inicial</label><input id="rot0" type="range" min="0" max="360" step="1" value="0"></div>
        <div class="row"><label for="outline">Contorno</label><input id="outline" type="range" min="0" max="4" step="0.5" value="1"></div>
      </div>
    </section>

    <!-- COLOR -->
    <section class="acc-item" id="sec-color">
      <button class="acc-btn" aria-expanded="false"><span>Color</span><span class="chev">▶</span></button>
      <div class="acc-panel">
        <div class="row"><label for="baseColor">Color base</label><input id="baseColor" type="color" value="#ff5ea8"></div>
        <div class="row"><label for="hVar">Variación (°)</label><input id="hVar" type="range" min="0" max="60" step="1" value="16"></div>
        <div class="row"><label for="grad">Gradiente centro→borde</label><input id="grad" type="range" min="0" max="1" step="0.01" value="0.6"></div>
        <div class="row"><label for="pAlpha">Opacidad pétalo</label><input id="pAlpha" type="range" min="0.3" max="1" step="0.01" value="0.95"></div>
      </div>
    </section>

    <!-- CENTRO -->
    <section class="acc-item" id="sec-centro">
      <button class="acc-btn" aria-expanded="false"><span>Centro</span><span class="chev">▶</span></button>
      <div class="acc-panel">
        <div class="row"><label for="coreR">Radio centro</label><input id="coreR" type="range" min="0" max="0.35" step="0.01" value="0.18"></div>
        <div class="row"><label for="pistils">Nº pistilos</label><input id="pistils" type="range" min="0" max="80" step="1" value="24"></div>
        <div class="row"><label for="pisSize">Tamaño pistilo</label><input id="pisSize" type="range" min="1" max="10" step="0.1" value="4"></div>
        <div class="row"><label for="pisColor">Color pistilo</label><input id="pisColor" type="color" value="#ffe580"></div>
      </div>
    </section>

    <!-- MODOS -->
    <section class="acc-item" id="sec-modos">
      <button class="acc-btn" aria-expanded="false"><span>Modos</span><span class="chev">▶</span></button>
      <div class="acc-panel">
        <div class="row"><label for="seed">Semilla</label><input id="seed" type="number" step="1" value="12345"></div>
        <div class="row" style="grid-column:1/-1">
          <div class="inline">
            <button class="btn" id="mutate">Mutar</button>
            <button class="btn" id="randomize">Aleatorio</button>
          </div>
        </div>
        <!-- Etiqueta encima del selector -->
        <div class="row stack"><label for="spin">Rotar</label>
          <select id="spin"><option value="off">Off</option><option value="slow" selected>Lenta</option><option value="med">Media</option><option value="fast">Rápida</option></select>
        </div>
        <!-- Etiqueta encima del selector -->
        <div class="row stack"><label for="breathe">“Respirar”</label>
          <select id="breathe"><option value="off" selected>Off</option><option value="soft">Suave</option><option value="deep">Profunda</option></select>
        </div>
        <p class="hint">Tip: toca “Aleatorio” para explorar paletas y formas nuevas.</p>
      </div>
    </section>
  </div>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const canvas = $('flower');
  const ctx = canvas.getContext('2d');

  /* ---------- TABS (móvil) + acordeón (desktop) ---------- */
  const tabbar = document.getElementById('tabbar');
  const tabs = tabbar ? Array.from(tabbar.querySelectorAll('.tab')) : [];
  const items = Array.from(document.querySelectorAll('.acc-item'));

  if (tabbar){
    tabbar.addEventListener('click', e=>{
      const btn = e.target.closest('.tab'); if(!btn) return;
      const id = btn.dataset.target;
      openSection(id);
      tabs.forEach(t => t.setAttribute('aria-selected', String(t===btn)));
      try { localStorage.setItem('flower.activeTab', id); } catch(e){}
    });
    try {
      const saved = localStorage.getItem('flower.activeTab');
      if (saved && document.getElementById(saved)) {
        openSection(saved);
        tabs.forEach(t => t.setAttribute('aria-selected', String(t.dataset.target===saved)));
      }
    } catch(e){}
  }

  const acc = document.getElementById('accordion');
  acc.addEventListener('click', (e)=>{
    const btn = e.target.closest('.acc-btn'); if(!btn) return;
    const item = btn.parentElement;
    const isOpen = item.classList.contains('open');
    items.forEach(it => { if(it!==item){ it.classList.remove('open'); it.querySelector('.acc-btn').setAttribute('aria-expanded','false'); }});
    item.classList.toggle('open', !isOpen);
    btn.setAttribute('aria-expanded', String(!isOpen));
  });

  function openSection(id){ items.forEach(it => it.classList.toggle('open', it.id===id)); }

  /* ---------- utilidades dibujo ---------- */
  function rng(seed){ return function(){ let t = seed += 0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }
  function hexToHsl(hex){ const n=parseInt(hex.slice(1),16); const r=((n>>16)&255)/255,g=((n>>8)&255)/255,b=(n&255)/255; const max=Math.max(r,g,b),min=Math.min(r,g,b); let h,s,l=(max+min)/2; if(max===min){h=s=0;} else { const d=max-min; s=l>0.5? d/(2-max-min): d/(max+min); switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;} h/=6;} return {h:h*360,s:s*100,l:l*100}; }
  function hslToCss(h,s,l,a=1){ return `hsla(${h.toFixed(1)},${s.toFixed(1)}%,${l.toFixed(1)}%,${a})`; }
  function phyllotaxisPoints(n,rMax){ const pts=[]; const ga=Math.PI*(3-Math.sqrt(5)); for(let i=0;i<n;i++){ const r=Math.sqrt(i/n)*rMax; const a=i*ga; pts.push({x:Math.cos(a)*r,y:Math.sin(a)*r}); } return pts; }
  function rgbToHex([r,g,b]){ const toHex=v=>('0'+v.toString(16)).slice(-2); return '#'+toHex(r)+toHex(g)+toHex(b); }
  function clamp01(v){ return Math.max(0.01, Math.min(1, v)); }
  function clampRange(v,a,b){ return Math.max(a, Math.min(b, v)); }

  const ui = {
    petals: $('petals'), pLen: $('pLen'), pWid: $('pWid'), pCurve: $('pCurve'), rot0: $('rot0'), outline: $('outline'),
    baseColor: $('baseColor'), hVar: $('hVar'), grad: $('grad'), pAlpha: $('pAlpha'),
    coreR: $('coreR'), pistils: $('pistils'), pisSize: $('pisSize'), pisColor: $('pisColor'),
    seed: $('seed'), mutate: $('mutate'), randomize: $('randomize'),
    spin: $('spin'), breathe: $('breathe'),
  };

  /* ---------- animación ---------- */
  let tLast = performance.now();
  let angleAnim = 0;

  function draw(now){
    const dt = Math.min(0.033, (now - tLast)/1000); tLast = now;

    // Rotación
    const spinSpeed = (ui.spin.value==='off'?0: ui.spin.value==='slow'?0.05: ui.spin.value==='med'?0.12:0.28);
    angleAnim += spinSpeed * dt;

    // Respiración (periodos largos y más amplitud)
    const breathModes = {
      off:  { amp: 0.00, period: 1 },
      soft: { amp: 0.06, period: 6 },   // ~6s ciclo completo
      deep: { amp: 0.12, period: 12 }   // ~12s ciclo completo
    };
    const bm = breathModes[ui.breathe.value] || breathModes.off;
    const omega = (2*Math.PI) / (bm.period*1000); // rad/ms
    const breath = 1 + Math.sin(now * omega) * bm.amp;

    const center = { x: canvas.clientWidth/2, y: canvas.clientHeight/2 };
    const R = Math.min(canvas.clientWidth, canvas.clientHeight) * 0.38 * breath;

    const rnd = rng(parseInt(ui.seed.value||0,10)>>>0);

    ctx.clearRect(0,0, canvas.clientWidth, canvas.clientHeight);

    ctx.save();
    ctx.translate(center.x, center.y);
    ctx.rotate((parseFloat(ui.rot0.value)*Math.PI/180) + angleAnim);

    const base = hexToHsl(ui.baseColor.value);
    const hVar = parseFloat(ui.hVar.value);
    const gradI = parseFloat(ui.grad.value);
    const pAlpha = parseFloat(ui.pAlpha.value);

    const n = parseInt(ui.petals.value,10);
    const L = R * parseFloat(ui.pLen.value);
    const W = R * parseFloat(ui.pWid.value);
    const ctrl = W * (0.5 + 0.9*parseFloat(ui.pCurve.value));
    const outline = parseFloat(ui.outline.value);

    const petalPath = new Path2D();
    petalPath.moveTo(0,0);
    petalPath.bezierCurveTo(+W,-ctrl,+W,-L*0.55,0,-L);
    petalPath.bezierCurveTo(-W,-L*0.55,-W,-ctrl,0,0);
    petalPath.closePath();

    for(let i=0;i<n;i++){
      const a = i*(2*Math.PI/n);
      ctx.save(); ctx.rotate(a);

      const h = base.h + (rnd()*2-1)*hVar;
      const s = Math.max(0,Math.min(100, base.s + (rnd()*2-1)*4));
      const lCenter = Math.max(0, Math.min(100, base.l + 18));
      const lEdge   = Math.max(0, Math.min(100, base.l - 8));

      const g = ctx.createLinearGradient(0,-L,0,0);
      g.addColorStop(0, hslToCss(h,s,lEdge,pAlpha));
      g.addColorStop(1, hslToCss(h,s,lCenter, Math.max(0,Math.min(1,pAlpha*(0.5+gradI*0.5)))));

      ctx.fillStyle = g;
      if (outline>0){ ctx.lineWidth = outline; ctx.strokeStyle = hslToCss(h,s,lEdge-8,0.9); }
      ctx.fill(petalPath);
      if (outline>0) ctx.stroke(petalPath);

      ctx.restore();
    }

    const coreR = R * parseFloat(ui.coreR.value);
    if (coreR>0){
      const coreGrad = ctx.createRadialGradient(0,0, coreR*0.1, 0,0, coreR);
      coreGrad.addColorStop(0, hslToCss(base.h, base.s*0.6, 95, 0.9));
      coreGrad.addColorStop(1, hslToCss(base.h, base.s*0.6, 70, 0.85));
      ctx.fillStyle = coreGrad;
      ctx.beginPath(); ctx.arc(0,0, coreR, 0, Math.PI*2); ctx.fill();
    }

    const np = parseInt(ui.pistils.value,10);
    const ps = parseFloat(ui.pisSize.value);
    if (np>0 && ps>0){
      const pts = phyllotaxisPoints(np, coreR*0.95);
      ctx.fillStyle = ui.pisColor.value;
      for (const p of pts){ ctx.beginPath(); ctx.arc(p.x,p.y,ps,0,Math.PI*2); ctx.fill(); }
    }

    ctx.restore();
    requestAnimationFrame(draw);
  }

  /* eventos UI */
  document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', () => {}));
  $('mutate').addEventListener('click', ()=>{
    ui.seed.value = (Math.random()*1e9|0);
    ui.pLen.value = clamp01(parseFloat(ui.pLen.value) + (Math.random()*0.3-0.15));
    ui.pWid.value = clamp01(parseFloat(ui.pWid.value) + (Math.random()*0.3-0.15));
    ui.pCurve.value = clamp01(parseFloat(ui.pCurve.value) + (Math.random()*0.3-0.15));
    ui.hVar.value = clampRange(parseFloat(ui.hVar.value) + (Math.random()*20-10), 0, 60);
    ui.rot0.value = (parseFloat(ui.rot0.value)+Math.random()*180)|0;
  });
  $('randomize').addEventListener('click', ()=>{
    ui.seed.value = (Math.random()*1e9|0);
    ui.petals.value = 3 + (Math.random()*61|0);
    ui.pLen.value = (Math.random()*0.7 + 0.3).toFixed(2);
    ui.pWid.value = (Math.random()*0.6 + 0.1).toFixed(2);
    ui.pCurve.value = Math.random().toFixed(2);
    ui.outline.value = (Math.random()*4).toFixed(1);
    ui.hVar.value = (Math.random()*60)|0;
    ui.grad.value = Math.random().toFixed(2);
    ui.pAlpha.value = (0.3 + Math.random()*0.7).toFixed(2);
    ui.coreR.value = (Math.random()*0.35).toFixed(2);
    ui.pistils.value = (Math.random()*80)|0;
    ui.pisSize.value = (1 + Math.random()*9).toFixed(1);
    ui.rot0.value = (Math.random()*360)|0;
    const hue=(Math.random()*360)|0, s=70+Math.random()*20, l=55+Math.random()*10;
    const tmp=document.createElement('canvas').getContext('2d');
    tmp.fillStyle=`hsl(${hue},${s}%,${l}%)`; tmp.fillRect(0,0,1,1);
    ui.baseColor.value = rgbToHex(tmp.getImageData(0,0,1,1).data);
    const hue2=(hue+40)%360;
    tmp.fillStyle=`hsl(${hue2},85%,75%)`; tmp.fillRect(0,0,1,1);
    ui.pisColor.value = rgbToHex(tmp.getImageData(0,0,1,1).data);
  });

  function clamp01(v){ return Math.max(0.01, Math.min(1, v)); }
  function clampRange(v,a,b){ return Math.max(a, Math.min(b, v)); }

  /* nitidez DPR */
  function fitCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
    canvas.width  = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  fitCanvas();
  new ResizeObserver(fitCanvas).observe(canvas);

  requestAnimationFrame(t=>{ tLast=t; requestAnimationFrame(draw); });
})();
</script>
</body>
</html>
