<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Generador de Flores</title>
<style>
  :root{
    --bg: #0b0f1a; --panel:#0f172a; --line:#1f2a3a; --txt:#eaf2ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Inter,Arial}
  .layout{min-height:100%;display:flex;flex-direction:column}
  @media (min-width:960px){ .layout{flex-direction:row} }

  /* VISOR (flor ~ 1/3 de pantalla) */
  .viewer{
    flex:1; display:flex; align-items:center; justify-content:center; padding:1rem;
  }
  .stage{
    position:relative; display:grid; place-items:center;
    width:min(92vw, 720px); aspect-ratio:3/2;
    border:8px solid #151f33; border-radius:18px; overflow:hidden;
    box-shadow:0 10px 40px rgba(0,0,0,.45);
    background: radial-gradient(120% 120% at 50% 15%, #0f1730 0%, #0b0f1a 65%);
  }
  canvas{ width:33vmin; height:33vmin; /* ~ un tercio del lado menor */ }

  /* CONTROLES */
  .controls{
    background:var(--panel); border-top:1px solid var(--line);
    padding:1rem; display:grid; gap:.9rem;
  }
  @media (min-width:960px){
    .controls{ width:360px; border-top:none; border-left:1px solid var(--line); overflow:auto; }
  }
  .group{border:1px solid #1a2540; border-radius:.8rem; padding:.8rem; display:grid; gap:.5rem; background:#0c1427}
  .title{font-size:.9rem; opacity:.85; margin-bottom:.2rem}
  .row{display:grid; grid-template-columns:140px 1fr; align-items:center; gap:.6rem}
  input[type="range"], input[type="color"], input[type="number"], select{
    width:100%; background:#0f1724; color:var(--txt); border:1px solid #233253; border-radius:.5rem; padding:.38rem;
    touch-action:manipulation;
  }
  .inline{display:flex; gap:.5rem; align-items:center}
  .btn{
    background:#15213a; border:1px solid #2a3a63; color:var(--txt);
    padding:.45rem .7rem; border-radius:.55rem; cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  .hint{font-size:.8rem; opacity:.75}
</style>
</head>
<body>
<div class="layout">
  <div class="viewer">
    <div class="stage">
      <canvas id="flower" width="900" height="900"></canvas>
    </div>
  </div>

  <div class="controls">
    <div class="group">
      <div class="title">Flor</div>
      <div class="row"><label>Nº pétalos</label><input id="petals" type="range" min="3" max="64" value="12"></div>
      <div class="row"><label>Largo pétalo</label><input id="pLen" type="range" min="0.3" max="1.0" step="0.01" value="0.8"></div>
      <div class="row"><label>Ancho pétalo</label><input id="pWid" type="range" min="0.10" max="0.70" step="0.01" value="0.35"></div>
      <div class="row"><label>Curvatura</label><input id="pCurve" type="range" min="0" max="1" step="0.01" value="0.6"></div>
      <div class="row"><label>Rotación inicial</label><input id="rot0" type="range" min="0" max="360" step="1" value="0"></div>
      <div class="row"><label>Contorno</label><input id="outline" type="range" min="0" max="4" step="0.5" value="1"></div>
    </div>

    <div class="group">
      <div class="title">Color</div>
      <div class="row"><label>Color base</label><input id="baseColor" type="color" value="#ff5ea8"></div>
      <div class="row"><label>Variación (°)</label><input id="hVar" type="range" min="0" max="60" step="1" value="16"></div>
      <div class="row"><label>Gradiente centro→borde</label><input id="grad" type="range" min="0" max="1" step="0.01" value="0.6"></div>
      <div class="row"><label>Opacidad pétalo</label><input id="pAlpha" type="range" min="0.3" max="1" step="0.01" value="0.95"></div>
    </div>

    <div class="group">
      <div class="title">Centro y pistilos</div>
      <div class="row"><label>Radio centro</label><input id="coreR" type="range" min="0" max="0.35" step="0.01" value="0.18"></div>
      <div class="row"><label>Nº pistilos</label><input id="pistils" type="range" min="0" max="80" step="1" value="24"></div>
      <div class="row"><label>Tamaño pistilo</label><input id="pisSize" type="range" min="1" max="10" step="0.1" value="4"></div>
      <div class="row"><label>Color pistilo</label><input id="pisColor" type="color" value="#ffe580"></div>
    </div>

    <div class="group">
      <div class="title">Aleatoriedad & Animación</div>
      <div class="row"><label>Semilla</label><input id="seed" type="number" step="1" value="12345"></div>
      <div class="inline">
        <button class="btn" id="mutate">Mutar</button>
        <button class="btn" id="randomize">Aleatorio</button>
      </div>
      <div class="row"><label>Rotar</label>
        <select id="spin"><option value="off">Off</option><option value="slow" selected>Lenta</option><option value="med">Media</option><option value="fast">Rápida</option></select>
      </div>
      <div class="row"><label>“Respirar”</label>
        <select id="breathe"><option value="off" selected>Off</option><option value="soft">Suave</option><option value="deep">Profunda</option></select>
      </div>
      <div class="hint">Consejo: cambia color base y “Variación (°)” para flores con carácter.</div>
    </div>
  </div>
</div>

<script>
(() => {
  // ---- Utils
  const $ = id => document.getElementById(id);
  const canvas = $('flower');
  const ctx = canvas.getContext('2d');

  // Seeded RNG (Mulberry32)
  function rng(seed){ return function(){ let t = seed += 0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }

  function hexToHsl(hex){
    const n = parseInt(hex.slice(1),16);
    const r=((n>>16)&255)/255, g=((n>>8)&255)/255, b=(n&255)/255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2;
    if(max===min){h=s=0;} else {
      const d=max-min; s=l>0.5? d/(2-max-min): d/(max+min);
      switch(max){case r: h=(g-b)/d + (g<b?6:0); break; case g: h=(b-r)/d + 2; break; case b: h=(r-g)/d + 4; break;}
      h/=6;
    }
    return {h:h*360, s:s*100, l:l*100};
  }
  function hslToCss(h,s,l,a=1){ return `hsla(${h.toFixed(1)},${s.toFixed(1)}%,${l.toFixed(1)}%,${a})`; }

  // Golden-angle points for pistils
  function phyllotaxisPoints(n, rMax){
    const pts=[]; const ga = Math.PI * (3 - Math.sqrt(5));
    for(let i=0;i<n;i++){
      const r = Math.sqrt(i/n) * rMax;
      const a = i * ga;
      pts.push({x: Math.cos(a)*r, y: Math.sin(a)*r});
    }
    return pts;
  }

  // ---- Params
  const ui = {
    petals: $('petals'), pLen: $('pLen'), pWid: $('pWid'), pCurve: $('pCurve'), rot0: $('rot0'), outline: $('outline'),
    baseColor: $('baseColor'), hVar: $('hVar'), grad: $('grad'), pAlpha: $('pAlpha'),
    coreR: $('coreR'), pistils: $('pistils'), pisSize: $('pisSize'), pisColor: $('pisColor'),
    seed: $('seed'), mutate: $('mutate'), randomize: $('randomize'),
    spin: $('spin'), breathe: $('breathe'),
  };

  // ---- Drawing
  let tLast = performance.now();
  let angleAnim = 0;
  function draw(now){
    const dt = Math.min(0.033, (now - tLast)/1000); tLast = now;

    // Anim speeds
    const spinMode = ui.spin.value;
    const breatheMode = ui.breathe.value;
    const spinSpeed = (spinMode==='off'?0: spinMode==='slow'? 0.05: spinMode==='med'? 0.12: 0.28); // rad/s
    angleAnim += spinSpeed * dt;

    const breathAmp = (breatheMode==='off'?0: breatheMode==='soft'? 0.02: 0.05);
    const breath = 1 + Math.sin(now*0.002)*breathAmp;

    const center = {x: canvas.width/2, y: canvas.height/2};
    const R = Math.min(canvas.width, canvas.height) * 0.42 * breath;

    // RNG by seed
    const rnd = rng(parseInt(ui.seed.value||0,10)>>>0);

    // Background clear (soft vignette)
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Group transform
    ctx.save();
    ctx.translate(center.x, center.y);
    ctx.rotate( (parseFloat(ui.rot0.value) * Math.PI/180) + angleAnim );

    // Colors
    const base = hexToHsl(ui.baseColor.value);
    const hVar = parseFloat(ui.hVar.value);
    const gradI = parseFloat(ui.grad.value);
    const pAlpha = parseFloat(ui.pAlpha.value);

    // Petal geometry
    const n = parseInt(ui.petals.value,10);
    const lenK = parseFloat(ui.pLen.value);        // 0.3..1
    const widK = parseFloat(ui.pWid.value);        // 0.1..0.7
    const curv = parseFloat(ui.pCurve.value);      // 0..1
    const outline = parseFloat(ui.outline.value);  // px

    // Precompute petal path in local coordinates
    const L = R * lenK;
    const W = R * widK;
    const ctrl = W * (0.5 + 0.9*curv);

    const petalPath = new Path2D();
    petalPath.moveTo(0,0);
    petalPath.bezierCurveTo(+W, -ctrl, +W, -L*0.55, 0, -L);   // derecha a punta
    petalPath.bezierCurveTo(-W, -L*0.55, -W, -ctrl, 0, 0);     // vuelve por izquierda
    petalPath.closePath();

    // Draw petals
    for(let i=0;i<n;i++){
      const a = i * (2*Math.PI / n);
      ctx.save();
      ctx.rotate(a);

      // Color variation per petal
      const h = base.h + (rnd()*2-1) * hVar;
      const s = Math.max(0, Math.min(100, base.s + (rnd()*2-1)*4));
      const lCenter = Math.max(0, Math.min(100, base.l + 18));  // más claro en el centro
      const lEdge   = Math.max(0, Math.min(100, base.l - 8));   // más oscuro en el borde

      // Gradient center->edge along y axis
      const g = ctx.createLinearGradient(0, -L, 0, 0);
      g.addColorStop(0, hslToCss(h, s, lEdge, pAlpha));
      g.addColorStop(1, hslToCss(h, s, lCenter, Math.max(0, Math.min(1, pAlpha*(0.5+gradI*0.5)))) );

      ctx.fillStyle = g;
      if (outline>0){ ctx.lineWidth = outline; ctx.strokeStyle = hslToCss(h, s, lEdge-8, 0.9); }
      ctx.fill(petalPath);
      if (outline>0) ctx.stroke(petalPath);

      ctx.restore();
    }

    // Core disk
    const coreR = R * parseFloat(ui.coreR.value);
    if (coreR>0){
      const coreGrad = ctx.createRadialGradient(0,0, coreR*0.1, 0,0, coreR);
      coreGrad.addColorStop(0, hslToCss(base.h, base.s*0.6, 95, 0.9));
      coreGrad.addColorStop(1, hslToCss(base.h, base.s*0.6, 70, 0.85));
      ctx.fillStyle = coreGrad;
      ctx.beginPath(); ctx.arc(0,0, coreR, 0, Math.PI*2); ctx.fill();
    }

    // Pistils
    const np = parseInt(ui.pistils.value,10);
    const ps = parseFloat(ui.pisSize.value);
    if (np>0 && ps>0){
      const pts = phyllotaxisPoints(np, coreR*0.95);
      ctx.fillStyle = ui.pisColor.value;
      for (const p of pts){
        ctx.beginPath(); ctx.arc(p.x, p.y, ps, 0, Math.PI*2); ctx.fill();
      }
    }

    ctx.restore();

    requestAnimationFrame(draw);
  }

  // ---- Events
  const inputs = document.querySelectorAll('input, select');
  inputs.forEach(el => el.addEventListener('input', () => {}));

  ui.mutate.addEventListener('click', ()=>{
    // small mutation: tweak sliders a bit & seed
    ui.seed.value = (Math.random()*1e9|0);
    ui.pLen.value = clamp01(parseFloat(ui.pLen.value) + (Math.random()*0.3-0.15));
    ui.pWid.value = clamp01(parseFloat(ui.pWid.value) + (Math.random()*0.3-0.15));
    ui.pCurve.value = clamp01(parseFloat(ui.pCurve.value) + (Math.random()*0.3-0.15));
    ui.hVar.value = clampRange(parseFloat(ui.hVar.value) + (Math.random()*20-10), 0, 60);
    ui.rot0.value = (parseFloat(ui.rot0.value)+Math.random()*180)|0;
  });
  ui.randomize.addEventListener('click', ()=>{
    ui.seed.value = (Math.random()*1e9|0);
    ui.petals.value = 3 + (Math.random()*61|0);
    ui.pLen.value = (Math.random()*0.7 + 0.3).toFixed(2);
    ui.pWid.value = (Math.random()*0.6 + 0.1).toFixed(2);
    ui.pCurve.value = Math.random().toFixed(2);
    ui.outline.value = (Math.random()*4).toFixed(1);
    ui.hVar.value = (Math.random()*60)|0;
    ui.grad.value = Math.random().toFixed(2);
    ui.pAlpha.value = (0.3 + Math.random()*0.7).toFixed(2);
    ui.coreR.value = (Math.random()*0.35).toFixed(2);
    ui.pistils.value = (Math.random()*80)|0;
    ui.pisSize.value = (1 + Math.random()*9).toFixed(1);
    ui.rot0.value = (Math.random()*360)|0;
    // base colors in pleasing ranges
    const hue = (Math.random()*360)|0, s=70+Math.random()*20, l=55+Math.random()*10;
    const tmp = document.createElement('canvas').getContext('2d'); // quick hsl->rgb
    tmp.fillStyle = `hsl(${hue},${s}%,${l}%)`; tmp.fillRect(0,0,1,1);
    ui.baseColor.value = rgbToHex(tmp.getImageData(0,0,1,1).data);
    const hue2 = (hue+40)%360;
    tmp.fillStyle = `hsl(${hue2},85%,75%)`; tmp.fillRect(0,0,1,1);
    ui.pisColor.value = rgbToHex(tmp.getImageData(0,0,1,1).data);
  });

  function rgbToHex([r,g,b]){
    const toHex = v => ('0'+v.toString(16)).slice(-2);
    return '#'+toHex(r)+toHex(g)+toHex(b);
  }
  function clamp01(v){ return Math.max(0.01, Math.min(1, v)); }
  function clampRange(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // Start
  requestAnimationFrame(t=>{ tLast=t; requestAnimationFrame(draw); });

  // Resize backing store for crispness
  function fitCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  new ResizeObserver(fitCanvas).observe(canvas);
})();
</script>
</body>
</html>
